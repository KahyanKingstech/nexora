<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Db</title>
    <script>
        const apiUrl = "http://127.0.0.1:9000/api/departments";

        async function fetchDepartments() {
            try {
                let response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                let data = await response.json();
                console.log("‚úÖ Full API Response:", data); // Debugging
                
                if (!data.departments || !Array.isArray(data.departments)) {
                    console.error("üö® 'departments' is missing or not an array:", data);
                    return;
                }

                let departments = data.departments;
                console.log("‚úÖ Extracted Departments:", departments); 

                let tableBody = document.getElementById("departmentsTable");
                tableBody.innerHTML = "";  

                departments.forEach(department => {
                    console.log("üîç Department Object:", department); // Debugging each department

                    // Check if department_id and department_name exist
                    if (!department.department_id || !department.department_name) {
                        console.error("‚ùå Missing properties in department:", department);
                        return;
                    }

                    let row = `<tr>
                        <td>${department.department_id}</td>
                        <td>${department.department_name}</td>
                        <td>
                            <button onclick="editDepartment('${department.department_id}', '${department.department_name}')">Edit</button>
                            <button onclick="deleteDepartment('${department.department_id}')">Delete</button>
                        </td>
                    </tr>`;
                    tableBody.insertAdjacentHTML("beforeend", row);
                });
            } catch (error) {
                console.error("‚ùå Error fetching departments:", error);
            }
        }



        // Add a new department
        async function addDepartment() {
            let department = {
                department_id: document.getElementById("department_id").value,
                department_name: document.getElementById("department_name").value
            };

            try {
                let response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(department)
                });

                if (!response.ok) {
                    let errorData = await response.json();
                    alert(errorData.detail || "Failed to add department");
                    return;
                }

                alert("Department added successfully");
                fetchDepartments();
            } catch (error) {
                console.error("Error adding department:", error);
            }
        }

        // Edit department (pre-fills form)
        function editDepartment(department_id, department_name) {
            document.getElementById("department_id").value = department_id;
            document.getElementById("department_name").value = department_name;
            document.getElementById("updateButton").style.display = "inline";
        }

        // Update department
        async function updateDepartment() {
            let department_id = document.getElementById("department_id").value;
            let updatedDepartment = {
                department_id: department_id,  // Include department_id in update
                department_name: document.getElementById("department_name").value
            };

            try {
                let response = await fetch(`${apiUrl}/${department_id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedDepartment)
                });

                if (!response.ok) {
                    let errorData = await response.json();
                    alert(errorData.detail || "Failed to update department");
                    return;
                }

                alert("Department updated successfully");
                fetchDepartments();
                document.getElementById("updateButton").style.display = "none";
            } catch (error) {
                console.error("Error updating department:", error);
            }
        }

        // Delete department
        async function deleteDepartment(department_id) {
            if (!confirm("Are you sure you want to delete this department?")) return;

            try {
                let response = await fetch(`${apiUrl}/${department_id}`, { method: "DELETE" });

                if (!response.ok) {
                    let errorData = await response.json();
                    alert(errorData.detail || "Failed to delete department");
                    return;
                }

                alert("Department deleted successfully");
                fetchDepartments();
            } catch (error) {
                console.error("Error deleting department:", error);
            }
        }

        // Load departments on page load
        window.onload = fetchDepartments;
    </script>
</head>
<body>
    <h2>Test Db</h2>

    <input type="text" id="department_id" placeholder="Department ID" required>
    <input type="text" id="department_name" placeholder="Department Name" required>
    <button onclick="addDepartment()">Add</button>
    <button id="updateButton" onclick="updateDepartment()" style="display:none;">Update</button>
    
    <br><br>
    <table border="1" style="width:100%;">
        <thead>
            <tr>
                <th>Department ID</th>
                <th>Department Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="departmentsTable"></tbody>
    </table>
</body>
</html>
